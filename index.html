<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tropics Hotel ‚Äì Reservas</title>

    <!-- Logo como favicon (opcional) -->
    <link rel="icon" href="/img/logo-tropics.jpg" />
    <link rel="stylesheet" href="/chat-widget.css" />

    <!-- Estilos/animaciones del CHAT (solo visual) -->
    <link rel="stylesheet" href="/visual/chat-visual.css" />
    <script defer src="/visual/chat-visual.js"></script>

    <style>
      :root { --brand:#123; --accent:#14b8a6; --jade:#00a86b; --jade2:#16c38a; }
      * { box-sizing:border-box; }

      /* ‚úÖ Fondo con TU nueva imagen (√∫nico cambio) */
      body {
        margin:0;
        font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        color:#1d1d1f;

        background-image: url('/img/bg-gray.jpg'); /* <-- NUEVO FONDO */
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
      }

      header { padding:20px 24px; border-bottom:1px solid #eee; position:sticky; top:0; background:#fff; z-index:5; display:flex; align-items:center; justify-content:space-between; }
      header .brand { display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px; color:var(--brand); }
      /* üî∏ logo clickeable (ampliaci√≥n en lightbox) */
      header .brand img { width:28px; height:28px; border-radius:6px; object-fit:cover; cursor:zoom-in; }

      .container { max-width:1100px; margin:0 auto; padding:24px; }

      .hero { display:grid; grid-template-columns:1.4fr 1fr; gap:24px; align-items:center; margin-top:8px; }
      .card { border:1px solid #eee; border-radius:14px; overflow:hidden; box-shadow:0 10px 20px rgba(0,0,0,.06); background:#fff; }
      .hero img { display:block; width:100%; height:360px; object-fit:cover; }
      .hero .copy { padding:16px 18px; }

      .rooms { margin-top:28px; }
      .rooms h2 { margin:0 0 12px; }
      .grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; }
      .room { position:relative; border:1px solid #eee; border-radius:12px; overflow:hidden; box-shadow:0 6px 14px rgba(0,0,0,.05); background:#fff; }
      .img-wrap { position:relative; cursor:pointer; }
      .img-wrap img { width:100%; height:200px; object-fit:cover; display:block; position:relative; z-index:1; }

      /* Overlay sobre la imagen (recibe clics) */
      .overlay {
        position:absolute; left:10px; right:10px; bottom:10px;
        display:flex; gap:8px; align-items:center; justify-content:space-between;
        z-index:2;
      }
      .badge-price {
        background:rgba(255,255,255,.92); color:#111;
        padding:6px 10px; border-radius:10px; font-weight:600; font-size:12px;
        backdrop-filter:saturate(1.2) blur(3px);
      }

      /* ===== Bot√≥n ‚Äú¬°Reserv√° ya!‚Äù (SOLO DISE√ëO) ===== */
      .btn-reserve {
        border:none; cursor:pointer;
        /* ‚úÖ degrad√© jade para m√°s presencia */
        background: linear-gradient(135deg, var(--jade), var(--jade2));
        color:#fff; font-weight:800; font-size:12px;
        padding:9px 14px; border-radius:999px;
        box-shadow: 0 8px 18px rgba(0,168,107,.35), inset 0 -1px 0 rgba(255,255,255,.25);
        transition: transform .16s ease, box-shadow .2s ease, filter .15s ease;
        position: relative; overflow: hidden;
      }
      /* ‚Äúlevitaci√≥n‚Äù y brillo */
      .btn-reserve:hover{
        transform: translateY(-2px);
        box-shadow: 0 12px 26px rgba(0,168,107,.45), inset 0 -1px 0 rgba(255,255,255,.3);
        filter: brightness(1.03);
      }
      .btn-reserve:active{
        transform: translateY(0);
        filter: saturate(1.06);
      }
      /* Efecto ‚Äúshine‚Äù sutil al pasar el mouse */
      .btn-reserve::before{
        content:"";
        position:absolute; top:-50%; left:-20%;
        width:40%; height:200%;
        transform: rotate(25deg);
        background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.45) 50%, rgba(255,255,255,0) 100%);
        opacity:0; pointer-events:none;
        transition: opacity .25s ease, left .6s ease;
      }
      .btn-reserve:hover::before{
        opacity:.9; left:120%;
      }

      .room .meta { padding:10px 12px; font-size:14px; display:flex; justify-content:space-between; align-items:center;}
      .pill { background:#f4f4f6; padding:4px 8px; border-radius:999px; font-size:12px; }

      /* üîπ Acciones bajo el nombre de la habitaci√≥n */
      .room-actions { display:flex; gap:8px; align-items:center; padding:0 12px 12px 12px; }
      .btn-secondary{
        border:1px solid #e5e7eb; background:#fff; color:#111; font-weight:600; font-size:12px;
        padding:8px 12px; border-radius:10px; cursor:pointer;
      }
      .btn-secondary:hover{ background:#f9fafb; }

      /* ==== Carrusel gen√©rico (hero & lobby) ==== */
      .slider { position:relative; }
      .slider .slide { width:100%; height:360px; object-fit:cover; display:block; }
      .slider .nav {
        position:absolute; top:50%; transform:translateY(-50%);
        background:rgba(0,0,0,.45); color:#fff; border:0; width:36px; height:36px;
        border-radius:999px; cursor:pointer; display:flex; align-items:center; justify-content:center;
      }
      .slider .prev { left:10px; }
      .slider .next { right:10px; }
      .slider .nav:hover { background:rgba(0,0,0,.6); }
      .slider .dots { position:absolute; left:0; right:0; bottom:10px; display:flex; gap:6px; justify-content:center; }
      .slider .dot { width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.7); border:1px solid rgba(0,0,0,.12); }
      .slider .dot.active { background:#fff; }

      /* üîñ Etiquetas sobre las fotos */
      .slider .tag-badge{
        position:absolute; top:10px; left:12px;
        padding:6px 10px; border-radius:10px;
        background:rgba(0,0,0,.55); color:#fff; font-weight:700; font-size:12px;
        letter-spacing:.2px; z-index:3; backdrop-filter:saturate(1.2) blur(2px);
      }

      /* ==== Lightbox ==== */
      .lightbox{
        position:fixed; inset:0; display:none;
        align-items:center; justify-content:center;
        background:rgba(10,12,16,.65);
        backdrop-filter:blur(4px);
        z-index:50;
      }
      .lightbox.open{ display:flex; }
      .lightbox .inner{
        position:relative; max-width:92vw; max-height:92vh;
        border-radius:14px; overflow:hidden; box-shadow:0 20px 45px rgba(0,0,0,.35);
        /* üü¢ CAMBIO: blanco para evitar franjas negras */
        background:#fff;
      }
      .lightbox img{
        display:block;
        /* üü¢ CAMBIO: ocupa todo el ancho disponible sin deformar */
        width:100%; height:auto;
        max-width:92vw; max-height:70vh;
        object-fit:contain;
        background:#fff; /* fondo blanco para evitar bordes oscuros */
      }
      .lightbox .close{
        position:absolute; top:10px; right:10px;
        background:rgba(0,0,0,.6); color:#fff; border:0; width:36px; height:36px;
        border-radius:999px; cursor:pointer; font-size:18px; line-height:36px; text-align:center;
      }
      .lightbox .close:hover{ background:rgba(0,0,0,.8); }

      /* üîπ Panel de descripci√≥n bajo la imagen del lightbox */
      .lightbox .caption{
        background:#fff; color:#111;
        padding:14px 16px; border-top:1px solid #111;
      }
      .lightbox .caption h3{ margin:0 0 6px; font-size:16px; }
      .lightbox .caption p{ margin:0; font-size:14px; line-height:1.45; }

      @media (max-width:1024px){ .hero{ grid-template-columns:1fr; } }
      @media (max-width:680px){ .grid{ grid-template-columns:1fr; } .slider .slide{ height:260px; } }
    </style>
  </head>
  <body>
    <header class="container">
      <div class="brand">
        <img id="logoImage" src="/img/logo-tropics.jpg" alt="Logo" onerror="this.style.display='none'">
        Tropics Hotel
      </div>
    </header>

    <main class="container">
      <section class="hero">
        <!-- ====== HERO / IZQUIERDA (Hotel) ====== -->
        <div class="card">
          <div class="slider" id="slider-hero" aria-label="Galer√≠a del hotel">
            <span class="tag-badge">Hotel</span>
            <img class="slide" id="hero-img" src="" alt="Hotel" />
            <button class="nav prev" type="button" aria-label="Anterior" id="hero-prev">‚Äπ</button>
            <button class="nav next" type="button" aria-label="Siguiente" id="hero-next">‚Ä∫</button>
            <div class="dots" id="hero-dots" aria-hidden="true"></div>
          </div>
          <div class="copy">
            <h1>Descans√° frente a la brisa del Oc√©ano √çndico.</h1>
            <p>Habitaciones luminosas, piscina al aire libre, almuerzo y desayuno tropical. Consult√° disponibilidad o reserv√° por el chat de la derecha: Asistente personal.</p>
            <p class="pill">Atenci√≥n 24/7 ¬∑ Confirmaci√≥n instant√°nea</p>
          </div>
        </div>

        <!-- ====== LOBBY / DERECHA ====== -->
        <div class="card">
          <div class="slider" id="slider-lobby" aria-label="Galer√≠a del lobby">
            <span class="tag-badge">Lobby</span>
            <img class="slide" id="lobby-img" src="" alt="Lobby" />
            <button class="nav prev" type="button" aria-label="Anterior" id="lobby-prev">‚Äπ</button>
            <button class="nav next" type="button" aria-label="Siguiente" id="lobby-next">‚Ä∫</button>
            <div class="dots" id="lobby-dots" aria-hidden="true"></div>
          </div>
        </div>
      </section>

      <!-- === HABITACIONES DIN√ÅMICAS DESDE GOOGLE SHEETS === -->
      <section class="rooms">
        <h2>Nuestras habitaciones</h2>
        <div id="rooms-grid" class="grid" aria-live="polite"></div>

        <!-- Plantilla de tarjeta -->
        <template id="room-card-template">
          <article class="room">
            <div class="img-wrap" role="button" tabindex="0" aria-label="Seleccionar habitaci√≥n">
              <img src="" alt="" />
              <div class="overlay">
                <span class="badge-price"></span>
                <button class="btn-reserve" type="button" aria-label="Reservar esta habitaci√≥n">¬°Reserv√° ya!</button>
              </div>
            </div>
            <div class="meta">
              <strong class="room-name"></strong>
              <span class="pill room-price"></span>
            </div>
            <!-- üîπ NUEVO: acciones bajo el nombre -->
            <div class="room-actions">
              <button class="btn-secondary btn-view" type="button" aria-label="Ver habitaci√≥n">Ver habitaci√≥n</button>
            </div>
          </article>
        </template>

        <p id="rooms-error" style="display:none; color:#b91c1c; font-size:14px; margin-top:8px;">
          No se pudo cargar el cat√°logo de habitaciones.
        </p>
      </section>
    </main>

    <!-- Lightbox global -->
    <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Imagen ampliada">
      <div class="inner">
        <button class="close" type="button" id="lbClose" aria-label="Cerrar">‚úï</button>
        <img id="lbImg" src="" alt="Imagen ampliada" />
        <!-- üîπ NUEVO: panel de texto bajo la imagen -->
        <div class="caption" id="lbCaption" style="display:none;">
          <h3 id="lbTitle"></h3>
          <p id="lbText"></p>
        </div>
      </div>
    </div>

    <!-- L√ìGICA: Carruseles + Lightbox -->
    <script>
      /* ===== Util: prueba .jpg/.jpeg/.webp autom√°ticamente ===== */
      function setImgWithFallback(imgEl, basePathWithoutExt, onload) {
        const exts = [".jpg",".jpeg",".webp"];
        let i = 0;
        function tryNext(){
          if (i >= exts.length) return;
          const url = basePathWithoutExt + exts[i++];
          imgEl.onload = () => { imgEl.onload = null; onload && onload(); };
          imgEl.onerror = tryNext;
          imgEl.src = url;
        }
        tryNext();
      }

      /* Probar si existe una imagen (cualquier extensi√≥n com√∫n) */
      /* Normalizar enlaces de Google Drive a directo (lh3) */
      function normalizeDriveUrl(u){
        if(!u) return u;
        try {
          const s = String(u);
          if (/lh3\.googleusercontent\.com\/d\//.test(s)) return s; // ya directo
          // /file/d/ID/view?...  o  /file/d/ID/preview
          let m = s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
          if (m && m[1]) return `https://lh3.googleusercontent.com/d/${m[1]}=w1600`;
          // open?id=ID  o  uc?id=ID
          m = s.match(/[?&](?:id|uc)\=([a-zA-Z0-9_-]+)/);
          if (m && m[1]) return `https://lh3.googleusercontent.com/d/${m[1]}=w1600`;
          return s;
        } catch { return u; }
      }

      function probeBaseExists(basePathWithoutExt, cb) {
        const exts = [".jpg",".jpeg",".webp"];
        let i = 0;
        function tryNext(){
          if (i >= exts.length) { cb(false); return; }
          const url = basePathWithoutExt + exts[i++];
          const im = new Image();
          im.onload = ()=> cb(true);
          im.onerror = tryNext;
          im.src = url;
        }
        tryNext();
      }

      (function(){
        /* ===== Lightbox ===== */
        const lb = document.getElementById('lightbox');
        const lbImg = document.getElementById('lbImg');
        const lbClose = document.getElementById('lbClose');
        const lbCaption = document.getElementById('lbCaption');
        const lbTitle = document.getElementById('lbTitle');
        const lbText = document.getElementById('lbText');

        // ‚¨áÔ∏è Extiendo para soportar t√≠tulo + texto (back-compatible con llamadas viejas)
        function openLB(src, alt, title, text){
          lbImg.src = src; lbImg.alt = alt || 'Imagen ampliada';
          if (title || text){
            lbTitle.textContent = title || '';
            lbText.textContent = text || '';
            lbCaption.style.display = 'block';
          } else {
            lbCaption.style.display = 'none';
            lbTitle.textContent = '';
            lbText.textContent = '';
          }
          lb.classList.add('open'); lb.setAttribute('aria-hidden','false'); lbClose.focus();
        }
        function closeLB(){
          lb.classList.remove('open'); lb.setAttribute('aria-hidden','true');
        }
        lbClose?.addEventListener('click', closeLB);
        lb?.addEventListener('click', (e)=>{ if(e.target === lb) closeLB(); });
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && lb.classList.contains('open')) closeLB(); });

        /* üî∏ Logo ampliable */
        const logo = document.getElementById('logoImage');
        if (logo) {
          logo.addEventListener('click', ()=> openLB(logo.src, 'Logo del hotel'));
        }

        /* ===== Carrusel: hero ===== */
        const heroImgs = ["/img/hotel-1", "/img/hotel-2", "/img/hotel-3"]; // sin extensi√≥n
        const heroImgEl = document.getElementById('hero-img');
        const heroDots = document.getElementById('hero-dots');
        let hi = 0;
        function renderHeroDots(){
          heroDots.innerHTML = "";
          heroImgs.forEach((_, idx) => {
            const d = document.createElement('div');
            d.className = 'dot' + (idx===hi ? ' active':'');
            d.addEventListener('click', ()=>showHero(idx));
            heroDots.appendChild(d);
          });
        }
        function showHero(idx){
          hi = (idx + heroImgs.length) % heroImgs.length;
          setImgWithFallback(heroImgEl, heroImgs[hi], renderHeroDots);
        }
        document.getElementById('hero-prev').addEventListener('click', ()=>showHero(hi-1));
        document.getElementById('hero-next').addEventListener('click', ()=>showHero(hi+1));
        heroImgEl.addEventListener('click', ()=> openLB(heroImgEl.src, 'Hotel'));
        showHero(0);

        /* ===== Carrusel: lobby (auto-agrega lobby-2 si existe) ===== */
        const lobbyBaseList = ["/img/lobby"]; // base sin extensi√≥n
        const lobbyImgEl = document.getElementById('lobby-img');
        const lobbyDots = document.getElementById('lobby-dots');
        let li = 0;

        function renderLobbyDots(){
          lobbyDots.innerHTML = "";
          lobbyBaseList.forEach((_, idx) => {
            const d = document.createElement('div');
            d.className = 'dot' + (idx===li ? ' active':'' );
            d.addEventListener('click', ()=>showLobby(idx));
            lobbyDots.appendChild(d);
          });
        }
        function showLobby(idx){
          li = (idx + lobbyBaseList.length) % lobbyBaseList.length;
          setImgWithFallback(lobbyImgEl, lobbyBaseList[li], renderLobbyDots);
        }
        document.getElementById('lobby-prev').addEventListener('click', ()=>showLobby(li-1));
        document.getElementById('lobby-next').addEventListener('click', ()=>showLobby(li+1));
        lobbyImgEl.addEventListener('click', ()=> openLB(lobbyImgEl.src, 'Lobby'));

        // inicial
        showLobby(0);

        // üî∏ si existe /img/lobby-2.(jpg|jpeg|webp), se agrega autom√°ticamente
        probeBaseExists("/img/lobby-2", (exists) => {
          if (exists) {
            lobbyBaseList.push("/img/lobby-2");
            renderLobbyDots();
          }
        });

        // Exponer openLB global para usarlo desde otras secciones (rooms)
        window.__openLB = openLB;
      })();
    </script>

    <!-- L√ìGICA DE HABITACIONES (intacta + integraci√≥n Reserva r√°pida + Ver habitaci√≥n) -->
    <script>
      (function(){
        // Orden visual
        const wantedNames = ["Suite premium","Simple est√°ndar","Simple est√°ndar","Doble est√°ndar"];

        // Base de im√°genes (el script intentar√° .jpg/.jpeg/.webp)
        const imageBaseMap = {
          "Suite premium": "suite-premium",
          "Simple est√°ndar": ["simple-estandar-1","simple-estandar-2"],
          "Doble est√°ndar": "doble-estandar"
        };
        const imagePickCount = {};

        const grid = document.getElementById('rooms-grid');
        const tpl  = document.getElementById('room-card-template');
        const err  = document.getElementById('rooms-error');

        const normalized = (s)=> String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();

        function pickBase(name){
          const v = imageBaseMap[name];
          if (!v) return null;
          if (Array.isArray(v)) {
            const used = imagePickCount[name] || 0;
            imagePickCount[name] = used + 1;
            return v[used % v.length];
          }
          return v;
        }

        function setImgWithFallbackRoom(imgEl, base) {
          const exts = [".jpg",".jpeg",".webp"];
          let i = 0;
          function tryNext(){
            if (i >= exts.length) {
              imgEl.src = "https://images.unsplash.com/photo-1551776235-dde6d4829808?q=80&w=1200&auto=format&fit=crop";
              return;
            }
            imgEl.onerror = () => { i++; tryNext(); };
            imgEl.src = "/img/" + base + exts[i];
          }
          tryNext();
        }

        function formatPrice(v, curr){
          if(!(Number.isFinite(v) && v>0)) return null;
          try { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: (curr||'USD') }).format(v); }
          catch { return (curr||'USD') + " " + v; }
        }

        /* ===== Apertura del chat y navegaci√≥n al flujo de RESERVA ===== */

        // Mantengo helpers existentes como fallback:
        function openChatFast() {
          try { if (window.ChatWidget && typeof window.ChatWidget.open === 'function') window.ChatWidget.open(); } catch(e){}
          const launcher = document.querySelector('#chat-widget-launcher, [data-cw="launcher"], .cw-launcher, button[aria-label="Asistente personal"]');
          if (launcher) { try { launcher.click(); } catch(e){} }
          const buttons = Array.from(document.querySelectorAll('button, a, div[role="button"]'));
          const cand = buttons.find(b => (b.innerText||'').toLowerCase().includes('asistente personal'));
          if (cand) { try { cand.click(); } catch(e){} }
        }

        function tryClickReserveButton() {
          const selectors = ['button','a','[role="button"]','.cw-chip','.cw-menu button','.cw-menu a'];
          const labels = ['hacer una reserva','reservar','reserva','book now','book','make a reservation'];
          for (const sel of selectors) {
            const nodes = document.querySelectorAll(sel);
            for (const n of nodes) {
              const t = (n.innerText || n.textContent || '').trim().toLowerCase();
              if (!t) continue;
              if (labels.some(lbl => t.includes(lbl))) {
                try { (n).click(); return true; } catch {}
              }
            }
          }
          return false;
        }

        function sendToChat(text){
          const start = performance.now();
          function tryNow(){
            const input = document.querySelector('#cw-text, #cw-input, [data-cw="input"], .cw-input textarea, .cw-input input, textarea, input[type="text"]');
            if (input && input.offsetParent !== null) {
              input.focus();
              input.value = text;
              input.dispatchEvent(new Event('input', {bubbles:true}));
              const sendBtn = document.querySelector('#cw-send, [data-cw="send"], .cw-send, button[type="submit"]');
              if (sendBtn) { try { sendBtn.click(); } catch(e){} }
              else { input.dispatchEvent(new KeyboardEvent('keydown', {key:'Enter', bubbles:true})); }
              return true;
            }
            if (performance.now() - start < 2200) { requestAnimationFrame(tryNow); return false; }
            window.postMessage({ type:'CW_PREFILL', text }, '*');
            return false;
          }
          tryNow();
        }

        // >>> ACTUALIZADO: usa la API del widget (Reserva r√°pida) y conserva fallback
        function launchReservation(roomName, priceFmt){
          // 1) Intento oficial: abrir panel + Reserva r√°pida con habitaci√≥n preseleccionada
          try {
            if (window.ChatWidget && typeof window.ChatWidget.startPreselected === 'function') {
              window.ChatWidget.startPreselected(roomName);
              return; // √©xito: no hace falta fallback
            }
          } catch(e){ /* contin√∫a al fallback */ }

          // 2) Fallback: abrir chat, intentar ‚ÄúHacer una reserva‚Äù por UI/texto
          openChatFast();

          let clicked = false;
          const t0 = performance.now();
          const spinClick = () => {
            if (!clicked) clicked = tryClickReserveButton();
            if (!clicked && performance.now() - t0 < 1000) requestAnimationFrame(spinClick);
          };
          spinClick();

          setTimeout(() => { if (!clicked) sendToChat('Hacer una reserva'); }, 350);

          const humanMsg = `Seleccion√© la habitaci√≥n "${roomName}"${priceFmt ? ` por ${priceFmt} por noche` : ''}.`;
          const setRoom  = `Habitaci√≥n: ${roomName}`;
          const askDates = `Continuemos con mi reserva. Por favor, pedime: fecha de entrada, fecha de salida (o cantidad de noches), mi nombre completo, email y tel√©fono.`;
          setTimeout(()=> sendToChat(humanMsg), 550);
          setTimeout(()=> sendToChat(setRoom),   800);
          setTimeout(()=> sendToChat(askDates), 1050);
        }

        /* ===== Helpers de ficha ===== */

        function normalizeAmenities(v){
          if (!v) return '';
          if (Array.isArray(v)) return v.map(x=>String(x).trim()).filter(Boolean).join(' ¬∑ ');
          const s = String(v);
          if (s.includes('¬∑')) return s.replace(/\s*¬∑\s*/g,' ¬∑ ').trim();
          if (s.includes('\n')) return s.split('\n').map(x=>x.trim()).filter(Boolean).join(' ¬∑ ');
          if (s.includes(',')) return s.split(',').map(x=>x.trim()).filter(Boolean).join(' ¬∑ ');
          return s.trim();
        }

        function openRoomDetails(roomName, imageUrl, amenitiesText){
          const title = roomName || 'Habitaci√≥n';
          const text  = amenitiesText || 'Informaci√≥n disponible en recepci√≥n.';
          const alt   = `Foto de ${title}`;
          const src   = imageUrl || 'https://images.unsplash.com/photo-1551776235-dde6d4829808?q=80&w=1200&auto=format&fit=crop';
          // usa el lightbox global extendido
          if (window.__openLB) window.__openLB(src, alt, title, text);
        }

        /* ===== Construcci√≥n de tarjetas desde Sheets ===== */

        fetch('/api/web/rooms')
          .then(r => r.json())
          .then(({ok, rooms}) => {
            if(!ok) throw new Error('rooms_api');
            const list = Array.isArray(rooms) ? rooms : [];

            const wantNorm = wantedNames.map(n => normalized(n));
            const chosen = [];
            for (const target of wantNorm) {
              const r = list.find(x => normalized(x.name) === target);
              chosen.push(r || { name: target, basePrice: null, currency: 'USD' });
            }

            grid.innerHTML = '';
            chosen.slice(0,4).forEach((r, idx) => {
              const node = document.importNode(tpl.content, true);
              const card = node.querySelector('.room');
              const imgWrap = node.querySelector('.img-wrap');
              const overlay = node.querySelector('.overlay');
              const img  = node.querySelector('img');
              const nm   = node.querySelector('.room-name');
              const pill = node.querySelector('.room-price');
              const badge= node.querySelector('.badge-price');
              const btn  = node.querySelector('.btn-reserve');
              const btnView = node.querySelector('.btn-view');

              const wantedNameOriginal = wantedNames[idx];
              const roomName = r.name || wantedNameOriginal || 'Habitaci√≥n';
              const priceFmt = formatPrice(Number(r.basePrice), r.currency);

              nm.textContent   = roomName;
              pill.textContent = priceFmt ? ('desde ' + priceFmt) : 'consultar';
              badge.textContent= priceFmt ? (priceFmt + ' / noche') : 'Consultar precio';

              // ========= ASIGNACI√ìN DE IMAGEN =========
              // Para "Simple est√°ndar", forzar alternancia entre im√°genes locales
              const normNameKey = normalized(roomName);
              if (normNameKey === 'simple estandar') {
                const base = pickBase('Simple est√°ndar'); // alterna entre simple-estandar-1/2
                if (base) setImgWithFallbackRoom(img, base);
              } else {
                // Comportamiento existente (Sheets primero, luego base local)
                const imageFromSheets = r.imageUrl || r.image || r.image_url || r.IMAGEN_URL;
                const normalizedImageFromSheets = normalizeDriveUrl(imageFromSheets);
                if (imageFromSheets) {
                  img.src = normalizedImageFromSheets || imageFromSheets;
                  img.onerror = () => {
                    const base = pickBase(wantedNameOriginal);
                    if (base) setImgWithFallbackRoom(img, base);
                  };
                } else {
                  const base = pickBase(wantedNameOriginal);
                  if (base) setImgWithFallbackRoom(img, base);
                }
              }
              // =========================================

              // Servicios / amenities desde Sheets
              const amenitiesText = normalizeAmenities(r.amenities || r.SERVICIOS || r.features || r.FEATURES);

              // === Acciones ===
              const handleReserve = (ev) => { ev?.preventDefault?.(); launchReservation(roomName, priceFmt); };
              btn.addEventListener('click', handleReserve);
              overlay.addEventListener('click', handleReserve);
              imgWrap.addEventListener('click', handleReserve);
              imgWrap.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') handleReserve(e); });

              // üîπ Ver habitaci√≥n: solo foto + servicios (sin abrir chat)
              btnView.addEventListener('click', (e)=> {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                // usamos la imagen renderizada en el DOM (ya alternada) para evitar duplicados
                openRoomDetails(roomName, img.src, amenitiesText);
              });

              grid.appendChild(node);
            });
          })
          .catch(() => { err.style.display = 'block'; });
      })();
    </script>

    <!-- Chat dock a la derecha (NO TOCAR) -->
    <script src="/chat-widget.js" defer></script>
  </body>
</html>
